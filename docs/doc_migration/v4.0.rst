.. Authors :
.. mviewer team

.. _migrationv4:

Mviewer 3.15 vers 4.0
=======================================

Introduction √† la migration
----------------------------

La migration vers la nouvelle version de mviewer apporte des √©volutions importantes, √† la fois sur l‚Äôinterface et sur l‚Äôorganisation du code. Ces changements ont √©t√© con√ßus pour moderniser l‚Äôapplication, la rendre plus l√©g√®re et plus modulable, et am√©liorer l‚Äôexp√©rience utilisateur.

Des changements d‚Äôinterfaces
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

La nouvelle version de mviewer modernise l‚Äôapplication pour garantir :

- **Une meilleure compatibilit√© avec les standards web** : votre application fonctionne correctement sur tous les navigateurs, toutes les tailles d‚Äô√©cran et tous les appareils.
- **Une interface plus coh√©rente et simplifi√©e** : les composants, menus et panneaux sont harmonis√©s pour faciliter la navigation.
- **Une exp√©rience utilisateur am√©lior√©e** : l‚Äôapplication est plus fluide et plus intuitive.

En adoptant cette version, vous b√©n√©ficiez donc d‚Äôune interface moderne, plus l√©g√®re et mieux adapt√©e aux besoins actuels des utilisateurs.

Utilisation des sous-d√©p√¥ts
~~~~~~~~~~~~~~~~~~~~~~~~~~~

La migration introduit √©galement l‚Äôutilisation de sous-d√©p√¥ts pour organiser les ressources optionnelles :

- **√âco-conception et modularit√©** : les d√©mos et addons sont d√©sormais optionnels. Vous pouvez utiliser mviewer sans les r√©cup√©rer, ou ne r√©cup√©rer que les composants dont vous avez r√©ellement besoin.
- **R√©duction du poids des clones** : le t√©l√©chargement initial de mviewer est plus l√©ger et plus rapide.
- **Mises √† jour ind√©pendantes** : les sous-d√©p√¥ts *mviewer-demo* et *mviewer-addons* √©voluent √† leur rythme. Les s√©parer √©vite de re-t√©l√©charger des fichiers inutiles lors des mises √† jour du c≈ìur mviewer.

Cette organisation rend l‚Äôapplication plus modulable et permet de gagner en efficacit√© tout en conservant la flexibilit√© n√©cessaire pour vos projets.

Changements majeurs
-------------------

**Migration Bootstrap 3 ‚Üí Bootstrap 5.3**

La mise √† jour de Bootstrap entra√Æne une √©volution importante des classes HTML et des composants.

‚û°Ô∏è Tous vos composants personnalis√©s doivent √™tre v√©rifi√©s afin d‚Äôassurer un affichage correct et, si n√©cessaire, √™tre adapt√©s. Vous trouverez √† la section *√âtapes de migration*, une liste des √©l√©ments √† v√©rifier.

Pour les mises √† jour de vos composants, r√©f√©rez-vous √† la documentation officielle Bootstrap 5.  
üìÑ https://getbootstrap.com/docs/5.3/getting-started/introduction/

**Fin des Glyphicons ‚Üí Passage aux Remix Icons**

Les Glyphicons ne sont plus fournis.

‚û°Ô∏è Utilisez Remix Icons (recommand√©) ou Font Awesome pour vos plugins, templates et composants personnalis√©s.

**Introduction des variables CSS pour la gestion du th√®me**

mviewer adopte d√©sormais un syst√®me bas√© sur des variables CSS.

‚û°Ô∏è Vous pouvez les utiliser dans vos d√©veloppements personnalis√©s (accueil, templates, customs‚Ä¶) pour simplifier la personnalisation et harmoniser le th√®me.

**Refonte compl√®te du mode mobile**

Le mode mobile b√©n√©ficie d‚Äôun nouveau syst√®me de navigation et d‚Äôune optimisation de l‚Äôergonomie.

‚û°Ô∏è Nous vous recommandons de v√©rifier le rendu de votre application sur plusieurs tailles d‚Äô√©cran.

**Optimisation des modes D√©faut / Simplifi√© / Ultra-simplifi√©**

Les comportements d‚Äôaffichage selon les largeurs d‚Äô√©cran ont √©t√© am√©lior√©s.

‚û°Ô∏è Nous vous recommandons de v√©rifier le rendu de votre application selon les diff√©rents modes via le menu *Partager la carte*.

**Suppression de la font Roboto**

Mviewer utilise d√©sormais la police syst√®me par d√©faut.

‚û°Ô∏è Pour int√©grer une police personnalis√©e, consultez la rubrique *Configurer - Apparence*.

**Organisation des ressources**

Les r√©pertoires ``/demo`` et ``/demo/addons`` sont maintenant des sous-modules Git. Vous pourrez les mettre √† jour, cibler des versions sp√©cifiques ou bien utiliser vos propres branches comme un projet Git classique.

√âtapes de migration
-------------------

Ces √©tapes ont pour objectif de vous guider dans la compr√©hension et la mise en ≈ìuvre de la migration. Vous comprendrez donc techniquement comment passer √† mviewer 4 selon votre environnement.

Cette section a √©t√© √©crite pour une migration de mviewer 3.x vers 4.0 car elle comporte des modifications impactantes (breaking changes).

.. note::
    Il est conseill√© d'avoir deux instances en parall√®le : une instance de prod et un mviewer 4.x pour effectuer tous les tests n√©cessaires.

A - Mise √† jour de votre instance
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Ce guide explique le passage de la branche ``master 3.x`` √† la branche ``master 4.0``. Cette documentation concerne donc la branche ``master``.

Si votre environnement est align√© sur la branche ``develop``, la proc√©dure est la m√™me.

Ce guide part du principe que les bonnes pratiques d√©crites dans la documentation mviewer sont respect√©es.

Toute modification dans le c≈ìur pourrait en effet g√©n√©rer des conflits √† la migration qui ne sauraient √™tre d√©crits dans aucune documentation.

1 - Nous allons v√©rifier que l'arborescence locale est propre ::

    cd mviewer
    git status

2 - Si vous avez fait des modifications dans ``/demo`` (au niveau des d√©mos ou des addons), alors il faudra renommer le r√©pertoire ``/demo`` (celui de master v3.x) afin d'√©viter des conflits avec le sous-d√©p√¥t portant le m√™me nom (il ne faut pas le supprimer pour conserver d'√©ventuelles personnalisations locales) ::

    mv demo demo.bak

3 - Cette commande va mettre √† jour la branche de travail et r√©cup√©rer le r√©pertoire ``/demo`` issu du sous-module ``mviewer-demo`` (m√™me s'il n'existe pas) ::

    git pull

4 - Initialiser et mettre √† jour les sous-d√©p√¥ts ::

    git submodule update --init --recursive

5 - Si vous commencez par cette version 4 ou bien souhaitez repartir de z√©ro, vous pouvez r√©cup√©rer directement les sous-d√©p√¥ts avec l'option ``--recurse-submodules`` (adaptez le nom de la branche master ou develop selon besoin) ::

    git clone https://github.com/mviewer/mviewer.git --branch develop --recurse-submodules

6 - Si vous aviez fait des modifications dans ``/demo`` et que vous avez renomm√© le r√©pertoire (``demo.bak``), alors le report de vos modifications devra √™tre fait manuellement.

- Les modifications dans ``/demo.bak/addons`` seront √† reporter dans ``mviewer-addons`` (ou dans votre fork).
- Les autres modifications dans ``/demo.bak`` seront √† reporter dans ``mviewer-demo`` (ou dans votre fork) en comparant vos changements avec les versions officielles.

Si besoin, aidez-vous du processus de contribution qui est d√©crit dans la documentation. N'h√©sitez-pas √† demander de l'aide √† la communaut√©.

B - √âl√©ments √† v√©rifier lors de la mise √† jour
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Si votre application contient des **√©l√©ments personnalis√©s (style CSS, page d'accueil ou template ...)**, veuillez v√©rifier les points suivants.

üó∫Ô∏è **APPLICATION**


**Avez-vous une page d‚Äôaccueil ?**


‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s  

‚úîÔ∏è Oui :

- Je v√©rifie le bon fonctionnement de l‚Äôaccueil dans la nouvelle version
- Si n√©cessaire, j‚Äôadapte le code selon la documentation officielle de Bootstrap 5

**Utilisez-vous un th√®me (hors DSFR) ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s  

‚úîÔ∏è Oui :

- J‚Äôutilise un th√®me par d√©faut disponible dans ``/css`` (ex : ``css/alizarin.css``) : je n‚Äôai aucune action √† r√©aliser, les th√®mes ont √©t√© mis √† jour et sont compatibles avec la nouvelle version
- J‚Äôutilise un th√®me personnalis√© : mon th√®me n‚Äôest malheureusement plus compatible avec cette nouvelle version. Je peux mettre √† jour mon th√®me personnalis√© en suivant la proc√©dure pr√©sent√©e √† la rubrique *Gestion d'un th√®me personnalis√©*.

**Utilisez-vous le th√®me DSFR (Design syst√®me de l'√âtat) ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s  

‚úîÔ∏è Oui : Cette version n‚Äôest pas encore compatible avec ce th√®me. Nous vous invitons donc √† patienter ou √† utiliser un th√®me par d√©faut.

**Utilisez-vous un plugin ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s  

‚úîÔ∏è Oui :

- J‚Äôutilise un plugin disponible dans le d√©p√¥t officiel mviewer :
  - Tous les plugins officiels ont √©t√© mis √† jour pour cette nouvelle version.
  - Pour garantir leur bon fonctionnement, il est n√©cessaire de reporter la configuration de votre ancien plugin vers sa nouvelle version (attention notamment √† la localisation des fichiers ``/lib``).
- J‚Äôutilise un plugin d√©velopp√© par mes soins :
  - Je v√©rifie le bon fonctionnement du plugin dans la nouvelle version
  - Si n√©cessaire, j‚Äôadapte le code selon la documentation officielle de Bootstrap 5 et en utilisant les d√©mos

.. warning::
    Les r√©pertoires ``addons`` ont √©t√© d√©plac√©s vers des d√©p√¥ts ind√©pendants, ce qui entra√Æne un changement d‚ÄôURL. Pour plus d‚Äôinformations, veuillez vous reporter √† la rubrique ci-dessous qui fait r√©f√©rence aux sous-d√©p√¥ts.

üåê **LAYER (pour chaque couche de l'application)**

**Avez-vous un custom layer ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s  

‚úîÔ∏è Oui :

- Le custom layer g√®re seulement le style de la couche
  - Aucun changement n‚Äôest requis, v√©rifiez simplement le rendu.
- Le custom layer int√®gre des composants suppl√©mentaires (alerte, panel‚Ä¶) ?
  - Je v√©rifie le bon fonctionnement dans la nouvelle version
  - Si n√©cessaire, j‚Äôadapte le code selon la documentation officielle de Bootstrap 5 et en utilisant les d√©mos

**Avez-vous un custom control ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s

‚úîÔ∏è Oui :

- Je v√©rifie le bon fonctionnement dans la nouvelle version
- Si n√©cessaire, j‚Äôadapte le code selon la documentation officielle de Bootstrap 5 et en utilisant les d√©mos

**Avez-vous un template mustache ?**

‚ùå Non : je passe √† l‚Äô√©tape d‚Äôapr√®s

‚úîÔ∏è Oui :

- Je v√©rifie le bon fonctionnement dans la nouvelle version
- Si n√©cessaire, j‚Äôadapte le code selon la documentation officielle de Bootstrap 5 et en utilisant les d√©mos

.. warning::
    La font Roboto n‚Äôest plus disponible. Veuillez supprimer les propri√©t√©s ``.css`` associ√©es dans votre template ou int√©grer la font dans votre application.

Gestion d'un th√®me personnalis√©
-------------------------------
.. warning::
    Les th√®mes cr√©√©s pour mviewer ‚â§3.15 ne sont **pas compatibles** avec mviewer 4. Il est donc n√©cessaire de mettre √† jour votre th√®me en suivant la proc√©dure ci-dessous.

Bonne nouvelle : la nouvelle approche bas√©e sur des variables CSS globales est plus simple, plus flexible et plus rapide √† maintenir. En quelques minutes, vous pouvez d√©sormais personnaliser l‚Äôapparence de votre application sans toucher au code des composants.

Cr√©ation ou mise √† jour d'un th√®me
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Pour adapter votre th√®me personnalis√©, remplacez les propri√©t√©s de style de votre fichier ``apps/monapp/montheme.css`` par un bloc de variables globales, par exemple ::

    @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

    :root {
      --mvcustom-color-primary: #5299a8;
      --mvcustom-font: 'Poppins', sans-serif;
      --mvcustom-rightpanel-size: 40%;
    }

**Remarque**

- Un exemple complet est disponible ici : https://github.com/mviewer/mviewer-demo/blob/main/customtheme/customstyle.css et dans ``demo/customtheme.xml``  
- Seules les variables souhait√©es doivent √™tre ajout√©es ; les autres conservent les valeurs par d√©faut.  
- Ajoutez vos styles sp√©cifiques apr√®s les variables globales si n√©cessaire.

Les variables globales
~~~~~~~~~~~~~~~~~~~~~~

Le bloc ``:root`` contient toutes les variables CSS permettant de **personnaliser l‚Äôapparence de votre application mviewer**.  
Ces variables rendent le th√®me facilement modifiable et coh√©rent, sans avoir √† intervenir dans chaque composant.

**Couleurs**

- ``--mvcustom-color-primary`` : couleur principale de l‚Äôapplication (HEX)
- ``--mvcustom-color-secondary`` : couleur secondaire pour un th√®me bicolore (HEX)

**Police**

- ``--mvcustom-font`` : police principale √† utiliser dans l‚Äôapplication

üí° Astuce : n‚Äôoubliez pas d‚Äôimporter la police via ``@import`` ou ``@font-face``.

**Bordures**

- ``--mvcustom-border-radius`` : d√©finit l‚Äôarrondi des composants d‚Äôinterface (``0`` ‚Üí bords carr√©s, ``5px`` ou plus ‚Üí coins arrondis)

**Taille des fen√™tres d'interrogation**

- ``--mvcustom-rightpanel-size`` : largeur du panel lat√©ral droit (en ``%`` ou ``px``)  
- ``--mvcustom-bottompanel-size`` : hauteur du panel inf√©rieur (en ``%`` ou ``px``)

**Navbar (barre de navigation)**

- ``--mvcustom-navbar-h`` : hauteur de la navbar (px)  
- ``--mvcustom-navbar-color`` : couleur du texte et des ic√¥nes (HEX)  
- ``--mvcustom-navbar-colorbody`` : couleur de fond de la navbar (HEX)

**Remarques**

‚Ä¢ Les variables sont compatibles avec les plugins et les composants Bootstrap 5 (ex : bouton).  
‚Ä¢ Les variables peuvent √™tre r√©utilis√©es partout dans vos fichiers mviewer (accueil, template, etc.) via ``var(--nom-de-la-variable)``.  
‚Ä¢ Modifier ces valeurs permet de changer rapidement et de mani√®re coh√©rente l‚Äôapparence de toute l‚Äôapplication. 


Gestion des sous-d√©p√¥ts
-----------------------

Utiliser (ou non) les sous-d√©p√¥ts
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Cette courte section sous la forme d'une FAQ vous permettra de comprendre comment utiliser les sous-modules et dans quel(s) cas il n'est pas utile de les utiliser.

**Je veux un clone qui r√©cup√®re tout le contenu en une seule commande GIT**

Pour r√©aliser un clonage initial sur la branche develop ou master (‚â• v4) avec les sous-modules ::

    cd <repertoire_parent_mviewer>
    git clone https://github.com/mviewer/mviewer.git --branch develop --recurse-submodules

**Je ne veux que le coeur mviewer (‚â• v4) sans d√©mos ni addons**

Dans ce cas, vous n'avez rien √† faire de plus que le clone. Le c≈ìur mviewer fonctionne seul, ce qui est utile pour un d√©ploiement minimal et l√©ger ::

    cd mviewer
    git clone https://github.com/mviewer/mviewer.git

**Je ne veux r√©cup√©rer que les addons sans r√©cup√©rer les d√©mos**

Auparavant, les addons √©taient dans ``/demo/addons``. Avec un mviewer ‚â• v4, ils sont √† la racine dans ``/addons``.

Si vous n'avez pas r√©cup√©r√© le contenu des addons ou bien avez fait un pull du mviewer v3 √† v4 sur votre branche de travail, alors le contenu du nouveau r√©pertoire ``/addons`` est vide.  
Cette commande vous permettra de r√©cup√©rer les addons dans ``/addons`` ::

    cd mviewer
    git submodule update --init addons

**Je souhaite tester les d√©mos sans les addons**

Ce n'est pas possible, puisque certaines d√©mos utilisent des addons. Il vous faudra donc un clonage complet pour avoir ``/addons`` et ``/demo`` √† la racine du mviewer.

**J'ai r√©alis√© un clone mviewer (‚â• v4), mais le contenu de /addons et /demo est vide**

Vous avez potentiellement r√©alis√© une commande de clone sans les param√®tres de r√©cup√©ration des sous-modules (``recurse``).  
Vous pouvez r√©cup√©rer ou mettre √† jour les sous-modules ainsi ::

    cd mviewer
    git submodule update --init --recursive

**Je souhaite mettre √† jour mon mviewer et les sous-modules**

Vous devez r√©aliser un pull et une mise √† jour des sous-modules.  
Les modifications r√©alis√©es dans ``/apps`` seront ignor√©es afin d'√©viter des conflits lors de la r√©cup√©ration des nouveaut√©s ::

    cd mviewer
    git pull
    git submodule update

**Je souhaite r√©cup√©rer les nouvelles d√©mos ou les addons sans mettre √† jour le coeur du mviewer**

Gr√¢ce au fonctionnement en sous-module, c'est possible. Voici les commandes ::

    cd mviewer
    git submodule update


Catalogue et liens
~~~~~~~~~~~~~~~~~~~

‚Ä¢ Le r√©pertoire ``/demo`` contient toutes les fichiers des d√©mos consultables √† l'URL suivante :  
  https://kartenn.region-bretagne.fr/kartoviz/demo/

‚Ä¢ Si vous souhaitez d√©ployer et personnaliser le catalogue mviewer, vous trouverez ici les sources et la documentation :  
  https://github.com/mviewer/mviewer-demo/tree/main/catalogue

‚Ä¢ Les liens pointant auparavant vers ``/demo/addons`` doivent maintenant viser ``/addons``.  
  Si vous exposez des ressources web ou documentations internes, mettez √† jour ces URLs apr√®s migration.

‚Ä¢ Les personnalisations personnelles restent toujours √† placer de pr√©f√©rence dans ``apps`` ou des d√©p√¥ts d√©di√©s pour √©viter les conflits lors des futures mises √† jour des sous-d√©p√¥ts.


Points d'attention
~~~~~~~~~~~~~~~~~~~

‚Ä¢ Les mises √† jour de mviewer peuvent modifier l'√©tat des sous-d√©p√¥ts ; ex√©cuter r√©guli√®rement ``git submodule update`` apr√®s un ``git pull``.  
‚Ä¢ Les pipelines CI/CD et scripts de d√©ploiement doivent √™tre adapt√©s pour initialiser les sous-d√©p√¥ts avant de construire ou publier les d√©mos et addons.  
‚Ä¢ Pour √©viter les conflits lors des prochaines mises √† jour, conserver vos personnalisations dans ``apps`` ou dans des d√©p√¥ts s√©par√©s plut√¥t que directement dans ``demo`` ou ``addons``.
